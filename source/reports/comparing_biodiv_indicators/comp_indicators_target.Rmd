---
title: "Compare biodiversity indicators from the b3gbi package"
author: "Emma Cartuyvels, Ward Langeraert, Toon Van Daele"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

# Introduction

In this document we compare a selection of B-cubed biodiversity indicators between actual cube data and data from structured monitoring. For more information on both datasets check the *Exploratory analysis from targets pipeline* html.

```{r setup, include = FALSE}
library(knitr)
opts_chunk$set(collapse = TRUE, comment = "#>")

library(targets)
library(b3gbi)
library(ggplot2)
library(cowplot)

# Folder to store figures
out_path <- here::here("output", "comp_indicators")
dir.create(out_path, recursive = TRUE, showWarnings = FALSE)

# Source functions
source(here::here("source", "R", "read_branch.R"))

# Globals
store <- file.path(
  here::here(), "source/pipelines/biodiversity_indicators/_targets"
)
```

# Biodiversity indicators

## Total occurrences

### Map

| Branch | Dataset        | Spatial resolution |
|:-------|:---------------|:-------------------|
| 1      | `abv_data`     | 1 km               |
| 2      | `abv_data`     | 10 km              |
| 3      | `birdflanders` | 1 km               |
| 4      | `birdflanders` | 10 km              |

```{r total occurrences map, fig.show="hold", out.width="50%"}
total_occ_map_abv <- read_branch(
  "total_occ_map",
  dataset = "abv_data",
  spat_res = 1,
  store = store
)
p <- plot(total_occ_map_abv)
p + labs(title = paste0(p$labels$title, " - ABV")) +
  theme_bw(base_size = 12)

total_occ_map_birdcube <- read_branch(
  "total_occ_map",
  dataset = "birdflanders",
  spat_res = 1,
  store = store
)
p <- plot(total_occ_map_birdcube)
p + labs(title = paste0(p$labels$title, " - Cube")) +
  theme_bw(base_size = 12)
```

What's interesting is that there are clearly certain areas in the cube that have much more occurrences than others. The ones on the coast are probably due to the gull data, the ones near and under Antwerp will need to be investigated further.

### Time series

1 km.

```{r total occurrences time series, fig.show="hold", out.width="50%"}
total_occ_ts_abv <- read_branch(
  "total_occ_ts",
  dataset = "abv_data",
  spat_res = 1,
  store = store
)
p <- plot(total_occ_ts_abv)
p + labs(title = paste0(p$labels$title, " - ABV")) +
  theme_bw(base_size = 12)

total_occ_ts_birdcube <- read_branch(
  "total_occ_ts",
  dataset = "birdflanders",
  spat_res = 1,
  store = store
)
p <- plot(total_occ_ts_birdcube)
p + labs(title = paste0(p$labels$title, " - Cube")) +
  theme_bw(base_size = 12)
```

Both data sets show big differences in the number of observations over the years, this will probably impact other indicators if this is not corrected for.

## Observed richness

### Map 1 km²

```{r observed richness map 1km, fig.show="hold", out.width="50%"}
obs_richness_map_abv_1 <- read_branch(
  "obs_richness_map",
  dataset = "abv_data",
  spat_res = 1,
  store = store
)
p <- plot(obs_richness_map_abv_1)
p + labs(title = paste0(p$labels$title, " - ABV")) +
  theme_bw(base_size = 12)

obs_richness_map_cube_1 <- read_branch(
  "obs_richness_map",
  dataset = "birdflanders",
  spat_res = 1,
  store = store
)
p <- plot(obs_richness_map_cube_1)
p + labs(title = paste0(p$labels$title, " - Cube")) +
  theme_bw(base_size = 12)
```

### Map 10 km²

```{r observed richness map, fig.show="hold", out.width="50%"}
obs_richness_map_abv_10 <- read_branch(
  "obs_richness_map",
  dataset = "abv_data",
  spat_res = 10,
  store = store
)
p1 <- plot(obs_richness_map_abv_10)
p1 + labs(title = paste0(p1$labels$title, " - ABV")) +
  theme_bw(base_size = 12)

obs_richness_map_cube_10 <- read_branch(
  "obs_richness_map",
  dataset = "birdflanders",
  spat_res = 10,
  store = store
)
p2 <- plot(obs_richness_map_cube_10)
p2 + labs(title = paste0(p2$labels$title, " - Cube")) +
  theme_bw(base_size = 12)
```

```{r, echo=FALSE}
fill_limits <- c(0, max(range(
  c(p1$data$diversity_val, p2$data$diversity_val),
  na.rm = TRUE
)))

# Clean figures
p1 <- p1 +
  scale_fill_viridis_c(name = "Species\nrichness",
                       limits = fill_limits,
                       na.value = "transparent") +
  ggtitle("")

p2 <- p2 +
  scale_fill_viridis_c(limits = fill_limits, na.value = "transparent") +
  ggtitle("")

# Extract legend (force top layout)
shared_legend <- get_legend(p1)

# Panels without legends
p_panels <- plot_grid(
  p1 +
    theme(legend.position = "none"),
  p2 +
    theme(legend.position = "none"),
  labels = c("A.", "B."),
  label_size = 20,
  ncol = 1
)

# Stack panels + legend vertically
p_range_comparison <- plot_grid(
  p_panels,
  shared_legend,
  ncol = 2,
  rel_widths = c(1, 0.12)
)

# Save
ggsave(
  file.path(out_path, "obs_richness_map.png"),
  p_range_comparison,
  width = 9, height = 6, dpi = 300
)
```

### Time series

```{r observed richness time series, fig.show="hold", out.width="50%"}
obs_richness_ts_abv <- read_branch(
  "obs_richness_ts",
  dataset = "abv_data",
  spat_res = 1,
  store = store
)
p1 <- plot(obs_richness_ts_abv)
p1 + labs(title = paste0(p1$labels$title, " - ABV")) +
  theme_bw(base_size = 12)

obs_richness_ts_cube <- read_branch(
  "obs_richness_ts",
  dataset = "birdflanders",
  spat_res = 1,
  store = store
)
p2 <- plot(obs_richness_ts_cube)
p2 + labs(title = paste0(p2$labels$title, " - Cube")) +
  theme_bw(base_size = 12)
```

```{r, echo=FALSE}
limits <- range(
  c(p1$data$diversity_val, p2$data$diversity_val),
  na.rm = TRUE
)

# Panels
p_panels <- plot_grid(
  p1 +
    scale_y_continuous(limits = limits) +
    labs(title = "", x = "", y = "Species richness") +
    theme_bw(base_size = 12),
  p2 +
    scale_y_continuous(limits = limits) +
    labs(title = "", x = "") +
    theme_bw(base_size = 12) +
    theme(axis.title.y = element_text(colour = alpha("black", 0))),
  labels = c("A.", "B."),
  label_size = 20,
  ncol = 2
)

# Save
ggsave(
  file.path(out_path, "obs_richness_ts.png"),
  p_panels,
  width = 10, height = 4, dpi = 300
)
```

## Pielou evenness

### Map

```{r pielou evenness map, fig.show="hold", out.width="50%"}
pielou_evenness_map_abv <- read_branch(
  "pielou_evenness_map",
  dataset = "abv_data",
  spat_res = 1,
  store = store
)
p <- plot(pielou_evenness_map_abv)
p + labs(title = paste0(p$labels$title, " - ABV")) +
  theme_bw(base_size = 12)

pielou_evenness_map_cube <- read_branch(
  "pielou_evenness_map",
  dataset = "birdflanders",
  spat_res = 1,
  store = store
)
p <- plot(pielou_evenness_map_cube)
p + labs(title = paste0(p$labels$title, " - Cube")) +
  theme_bw(base_size = 12)
```

### Time series

```{r pielou evenness time series, fig.show="hold", out.width="50%"}
pielou_evenness_ts_abv <- read_branch(
  "pielou_evenness_ts",
  dataset = "abv_data",
  spat_res = 1,
  store = store
)
p1 <- plot(pielou_evenness_ts_abv)
p1 + labs(title = paste0(p1$labels$title, " - ABV")) +
  theme_bw(base_size = 12)

pielou_evenness_ts_cube <- read_branch(
  "pielou_evenness_ts",
  dataset = "birdflanders",
  spat_res = 1,
  store = store
)
p2 <- plot(pielou_evenness_ts_cube)
p2 + labs(title = paste0(p2$labels$title, " - Cube")) +
  theme_bw(base_size = 12)
```

```{r, echo=FALSE}
# Panels
p_panels <- plot_grid(
  p1 +
    scale_y_continuous(limits = c(0, 1)) +
    labs(title = "", x = "") +
    theme_bw(base_size = 12),
  p2 +
    scale_y_continuous(limits = c(0, 1)) +
    labs(title = "", x = "") +
    theme_bw(base_size = 12) +
    theme(axis.title.y = element_text(colour = alpha("black", 0))),
  labels = c("A.", "B."),
  label_size = 20,
  ncol = 2
)

# Save
ggsave(
  file.path(out_path, "pielou_evenness_ts.png"),
  p_panels,
  width = 10, height = 4, dpi = 300
)
```

# Species-specific indicators {.tabset}

We chose three species to compare the indicators between the two data sets:

-   The species with the biggest increase according to the ABV: Cetti's warbler (*Cettia cetti*)
-   The species with the biggest decrease according to the ABV: Eurasian tree sparrow (*Passer montanus*)
-   A species with a very stable trend: Common nightingale (*Luscinia megarhynchos*)

## Cetti's Warbler

### Species occurrences

#### Map

```{r species occurrences map cettis warbler, fig.show="hold", out.width="50%"}
spec_occ_map_abv <- read_branch(
  "spec_occ_map",
  dataset = "abv_data",
  spat_res = 10,
  store = store
)
p <- plot(spec_occ_map_abv, species = "Cettia cetti") +
  theme_bw(base_size = 12)
p

spec_occ_map_cube <- spec_occ_map_abv <- read_branch(
  "spec_occ_map",
  dataset = "birdflanders",
  spat_res = 10,
  store = store
)
p <- plot(spec_occ_map_cube, species = "Cettia cetti") +
  theme_bw(base_size = 12)
p
```

#### Time series

```{r species occurrences time series cettis warbler, fig.show="hold", out.width="50%"}
spec_occ_ts_abv <- read_branch(
  "spec_occ_ts",
  dataset = "abv_data",
  spat_res = 10,
  store = store
)
p <- plot(spec_occ_ts_abv, species = "Cettia cetti") +
  theme_bw(base_size = 12)
p

spec_occ_ts_cube <- read_branch(
  "spec_occ_ts",
  dataset = "birdflanders",
  spat_res = 10,
  store = store
)
p <- plot(spec_occ_ts_cube, species = "Cettia cetti") +
  theme_bw(base_size = 12)
p
```

### Species range

#### Map

```{r species range map cettis warbler, fig.show="hold", out.width="50%"}
spec_range_map_abv <- read_branch(
  "spec_range_map",
  dataset = "abv_data",
  spat_res = 10,
  store = store
)
p <- plot(spec_range_map_abv, species = "Cettia cetti") +
  theme_bw(base_size = 12)
p

spec_range_map_cube <- read_branch(
  "spec_range_map",
  dataset = "birdflanders",
  spat_res = 10,
  store = store
)
p <- plot(spec_range_map_cube, species = "Cettia cetti") +
  theme_bw(base_size = 12)
p
```

#### Time series

```{r species range time series cettis warbler, fig.show="hold", out.width="50%"}
spec_range_ts_abv <- read_branch(
  "spec_range_ts",
  dataset = "abv_data",
  spat_res = 10,
  store = store
)
p <- plot(spec_range_ts_abv, species = "Cettia cetti") +
  theme_bw(base_size = 12)
p

spec_range_ts_cube <- read_branch(
  "spec_range_ts",
  dataset = "birdflanders",
  spat_res = 10,
  store = store
)
p <- plot(spec_range_ts_cube, species = "Cettia cetti") +
  theme_bw(base_size = 12)
p
```

## Eurasian tree sparrow

### Species occurrences

#### Map

```{r species occurrences map tree sparrow, fig.show="hold", out.width="50%"}
spec_occ_map_abv <- read_branch(
  "spec_occ_map",
  dataset = "abv_data",
  spat_res = 10,
  store = store
)
p <- plot(spec_occ_map_abv, species = "Passer montanus") +
  theme_bw(base_size = 12)
p

spec_occ_map_cube <- spec_occ_map_abv <- read_branch(
  "spec_occ_map",
  dataset = "birdflanders",
  spat_res = 10,
  store = store
)
p <- plot(spec_occ_map_cube, species = "Passer montanus") +
  theme_bw(base_size = 12)
p
```

#### Time series

```{r species occurrences time series tree sparrow, fig.show="hold", out.width="50%"}
spec_occ_ts_abv <- read_branch(
  "spec_occ_ts",
  dataset = "abv_data",
  spat_res = 10,
  store = store
)
p <- plot(spec_occ_ts_abv, species = "Passer montanus") +
  theme_bw(base_size = 12)
p

spec_occ_ts_cube <- read_branch(
  "spec_occ_ts",
  dataset = "birdflanders",
  spat_res = 10,
  store = store
)
p <- plot(spec_occ_ts_cube, species = "Passer montanus") +
  theme_bw(base_size = 12)
p
```

### Species range

#### Map

```{r species range map tree sparrow, fig.show="hold", out.width="50%"}
spec_range_map_abv <- read_branch(
  "spec_range_map",
  dataset = "abv_data",
  spat_res = 10,
  store = store
)
p <- plot(spec_range_map_abv, species = "Passer montanus") +
  theme_bw(base_size = 12)
p

spec_range_map_cube <- read_branch(
  "spec_range_map",
  dataset = "birdflanders",
  spat_res = 10,
  store = store
)
p <- plot(spec_range_map_cube, species = "Passer montanus") +
  theme_bw(base_size = 12)
p
```

#### Time series

```{r species range time series tree sparrow, fig.show="hold", out.width="50%"}
spec_range_ts_abv <- read_branch(
  "spec_range_ts",
  dataset = "abv_data",
  spat_res = 10,
  store = store
)
p <- plot(spec_range_ts_abv, species = "Passer montanus") +
  theme_bw(base_size = 12)
p

spec_range_ts_cube <- read_branch(
  "spec_range_ts",
  dataset = "birdflanders",
  spat_res = 10,
  store = store
)
p <- plot(spec_range_ts_cube, species = "Passer montanus") +
  theme_bw(base_size = 12)
p
```

## Common nightingale

### Species occurrences

#### Map

```{r species occurrences map nightingale, fig.show="hold", out.width="50%"}
spec_occ_map_abv <- read_branch(
  "spec_occ_map",
  dataset = "abv_data",
  spat_res = 10,
  store = store
)
p <- plot(spec_occ_map_abv, species = "Luscinia megarhynchos") +
  theme_bw(base_size = 12)
p

spec_occ_map_cube <- spec_occ_map_abv <- read_branch(
  "spec_occ_map",
  dataset = "birdflanders",
  spat_res = 10,
  store = store
)
p <- plot(spec_occ_map_cube, species = "Luscinia megarhynchos") +
  theme_bw(base_size = 12)
p
```

#### Time series

```{r species occurrences time series nightingale, fig.show="hold", out.width="50%"}
spec_occ_ts_abv <- read_branch(
  "spec_occ_ts",
  dataset = "abv_data",
  spat_res = 10,
  store = store
)
p <- plot(spec_occ_ts_abv, species = "Luscinia megarhynchos") +
  theme_bw(base_size = 12)
p

spec_occ_ts_cube <- read_branch(
  "spec_occ_ts",
  dataset = "birdflanders",
  spat_res = 10,
  store = store
)
p <- plot(spec_occ_ts_cube, species = "Luscinia megarhynchos") +
  theme_bw(base_size = 12)
p
```

### Species range

#### Map

```{r species range map nightingale, fig.show="hold", out.width="50%"}
spec_range_map_abv <- read_branch(
  "spec_range_map",
  dataset = "abv_data",
  spat_res = 10,
  store = store
)
p <- plot(spec_range_map_abv, species = "Luscinia megarhynchos") +
  theme_bw(base_size = 12)
p

spec_range_map_cube <- read_branch(
  "spec_range_map",
  dataset = "birdflanders",
  spat_res = 10,
  store = store
)
p <- plot(spec_range_map_cube, species = "Luscinia megarhynchos") +
  theme_bw(base_size = 12)
p
```

#### Time series

```{r species range time series nightingale, fig.show="hold", out.width="50%"}
spec_range_ts_abv <- read_branch(
  "spec_range_ts",
  dataset = "abv_data",
  spat_res = 10,
  store = store
)
p <- plot(spec_range_ts_abv, species = "Luscinia megarhynchos") +
  theme_bw(base_size = 12)
p

spec_range_ts_cube <- read_branch(
  "spec_range_ts",
  dataset = "birdflanders",
  spat_res = 10,
  store = store
)
p <- plot(spec_range_ts_cube, species = "Luscinia megarhynchos") +
  theme_bw(base_size = 12)
p
```
