---
title: "Exploratory analysis from targets pipeline"
author: "Emma Cartuyvels, Ward Langeraert, Toon Van Daele"
date: "`r Sys.Date()`" 
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
library(knitr)
opts_chunk$set(collapse = TRUE, comment = "#>")

library(targets)
Sys.setenv(TAR_PROJECT = "exploratory_analysis")

library(ggplot2)
library(ggpubr)
library(dplyr)
library(ggforce)
library(crosstalk)
library(DT)
library(plotly)
```

```{r consistent colors}
# Create a custom color scale
library(RColorBrewer)
my_colors <- brewer.pal(5, "Dark2")
names(my_colors) <- c("Very rare", "Rare", "Common",
                      "Very common", "Extremely common")
col_scale <- scale_color_manual(name = "Category",
                                values = my_colors)
fill_scale <- scale_fill_manual(name = "Category",
                                values = my_colors)
```

In this document we explore the ABV data set, the cube data generated for birds in Flanders and if there is any indication that the occurrences in both datasets show similar ranges and trends. We also explore if certain filters can help improve performance of maps and trends based on the cube data when comparing these to the structured ABV data.

The following filters are used:

  - No filter
  - Filter 1: only species that were analysed in the ABV framework ([further reading](https://inbo.github.io/abv-rapport/2023/methodologie/verwerking.html))
  - Filter 2: loosely based on the rules set in the ABV framework
    - A square is only relevant for a species if that species is observed in this square for more than one time period
    - A minimum of three relevant squares are needed to include the species
    - A minimum of a hundred observations are needed to include the species
  - Filter 3: number of observations is weighed by total number of observations for that year

## Data exploration

```{r}
abv <- tar_read(data) |>
  filter(id_dataset == "abv_data",
         id_spat_res == "1km")
cube <- tar_read(data) |>
  filter(id_dataset == "birdflanders",
         id_spat_res == "1km")
```

During our initial analysis we noticed some problems with species names:

  - *Poecile montanus* and *Parus montanus*, *Dendrocopus major* and *Dendrocopos major* both refer to the same species. Both species names are accepted names in GBIF but they are not interlinked.
  - *Saxicola torquatus* is most likely a wrong name and needs to be replaced with *Saxicola rubicola*.

Issues were opened respectively trough GBIF and with the ABV data publisher. Species names were manually changed to allow comparisons in further analyses. However, it is important to remember that similar errors will probably occur when generating different cubes.

### The ABV dataset

The ABV dataset, which stands for Algemene Broedvogelmonitoring Vlaanderen (Common Breeding Bird Survey Flanders), is a structured monitoring dataset that tracks a group of approximately 100 common breeding bird species in Flanders, Belgium. Monitoring began in 2007 and the protocol involves selecting a random sample of 1200 UTM 1x1 km grid cells, stratified by land use. These cells are divided into groups of 300, and 300 grid cells are visited each year on a three-year rotation. Each grid cell contains six monitoring locations where bird counts are conducted. The data collection is standardized, with each grid cell being visited three times a year at fixed intervals (at least two weeks apart).

```{r}
abv |>
  ggplot(aes(x = year, y = n)) +
  geom_bar(stat = "identity",
           fill = "#1B9E77") +
  scale_x_continuous(breaks = sort(unique(abv$year)))
```

The ABV data ranges from over 40.000 observations in 2007 to just over 20.000 observations in 2022.

```{r}
abv |>
  group_by(species) |>
  summarise(n_obs = sum(n)) |>
  ggplot(aes(x = n_obs)) +
  geom_histogram(fill = "#D95F02", color = "black") +
  labs(x = "Number of observations",
       y = "Number of species")
```

180 bird species were recorded, of which 34 were recorded < 10 times (very rare), 29 were recorded between 10 and 100 times (rare), 59 were recorded between 100 and 1000 times (common), 43 were recorded between 1000 and 10000 times (very common) and 15 were recorded more than 10 000 times (extremely common).

This categorization is used throughout further analyses.

```{r}
abv |>
  distinct(category, species) |>
  count(category) |>
  knitr::kable()
```

### The cube data

A data cube is a multidimensional representation of data that allows for efficient storage, retrieval, and analysis of information along multiple dimensions. In the context of biodiversity data, a data cube can integrate various dimensions such as taxonomic (what), temporal (when) and spatial (where), enabling researchers to explore complex ecological patterns and relationships more effectively. More information can be found [here](https://docs.b-cubed.eu/occurrence-cube/specification/#dimensions).

We downloaded the occurrence cube from GBIF, selecting all birds in Flanders aggregated on the utm1-grid and per year. Observations from ABV monitoring (also published on GBIF) were excluded.

The cube is made up of several datasets:

  - Waarnemingen.be - Bird occurrences in Flanders and the Brussels Capital Region, Belgium
  - Watervogels - Wintering waterbirds in Flanders, Belgium
  - HG_OOSTENDE - Herring gulls (Larus argentatus, Laridae) breeding at the southern North Sea coast (Belgium)
  - EOD â€“ eBird Observation Dataset
  - Waarnemingen.be - Non-native animal occurrences in Flanders and the Brussels Capital Region, Belgium
  - LBBG_ZEEBRUGGE - Lesser black-backed gulls (Larus fuscus, Laridae) breeding at the southern North Sea coast (Belgium and the Netherlands)
  - Broedvogels - Atlas of the breeding birds in Flanders 2000-2002
  - European Seabirds At Sea (ESAS)
  - And 80+ smaller datasets
  
With the first dataset (waarnemingen.be) containing most of the observations (67%). For further analyses it is important to know that waarnemingen.be data was last published in 2019 and currently runs only to 31-12-2018.

```{r}
cube |>
  ggplot(aes(x = year, y = n)) +
  geom_bar(stat = "identity",
           fill = "#7570B3") +
  scale_x_continuous(breaks = sort(unique(cube$year)))
```

```{r}
cube |>
  group_by(species) |>
  summarise(n_obs = sum(n)) |>
  ggplot(aes(x = n_obs)) +
  geom_histogram(fill = "#E7298A", color = "black") +
  labs(x = "Number of observations",
       y = "Number of species")
```

```{r}
cube |>
  group_by(species) |>
  summarise(n_obs = sum(n)) |>
  mutate(category = cut(n_obs,
                        breaks = c(-Inf, 0, 1, 10, 100, 1000, 10000, Inf),
                        right = FALSE)) |>
  count(category) |>
  knitr::kable()
```


The cube contains information on 663 species. 25 of these are hybrids. 355 of these were observed less than a 100 times, 197 were observed more than 1000 times.

```{r}
cube |>
  ggplot(aes(x = mincoordinateuncertaintyinmeters)) +
  geom_histogram(fill = "#66A61E", color = "black",
                 bins = 100) +
  labs(x = "Minimum coordinate uncertainty in meters",
       y = "Count") +
  facet_zoom(zoom.size = 0.5,
             ylim = c(0, 300),
             xlim = c(10500, 150000),
             horizontal = FALSE)
```


## Occupancy comparison {.tabset}

### No filter

```{r}
tar_read(range_comp_0) |>
  filter(id_spat_res == "1km") |>
  ggplot(aes(x = percentage_abv_data,
             y = percentage_birdflanders,
             color = category)) +
  geom_point() +
  col_scale +
  stat_cor(mapping = aes(color = NULL),
           label.x.npc = "centre",
           label.y.npc = "bottom",
           method = "pearson") +
  labs(x = "Percentage of ABV squares occupied\nby species in ABV dataset",
       y = "Percentage of cube squares occupied\nby species in cube dataset") +
  guides(color = guide_legend(override.aes = aes(label = "")))
```

### Filter 1

```{r}
tar_read(range_comp_1) |>
  filter(id_spat_res == "1km") |>
  ggplot(aes(x = percentage_abv_data,
             y = percentage_birdflanders,
             color = category)) +
  geom_point() +
  col_scale +
  stat_cor(mapping = aes(color = NULL),
           label.x.npc = "centre",
           label.y.npc = "bottom",
           method = "pearson") +
  labs(x = "Percentage of ABV squares occupied\nby species in ABV dataset",
       y = "Percentage of cube squares occupied\nby species in cube dataset") +
  guides(color = guide_legend(override.aes = aes(label = "")))
```

### Filter 2

```{r}
tar_read(range_comp_2) |>
  filter(id_spat_res == "1km") |>
  filter(id_filter_per == "year") |>
  ggplot(aes(x = percentage_abv_data,
             y = percentage_birdflanders,
             color = category)) +
  geom_point() +
  col_scale +
  stat_cor(mapping = aes(color = NULL),
           label.x.npc = "centre",
           label.y.npc = "bottom",
           method = "pearson") +
  labs(x = "Percentage of ABV squares occupied\nby species in ABV dataset",
       y = "Percentage of cube squares occupied\nby species in cube dataset") +
  guides(color = guide_legend(override.aes = aes(label = "")))
```

##

Given the limitations of the ABV monitoring setup we can't compare exact patterns in biodiversity, for this we refer to the South-African analysis.

## Trend comparison {.tabset}

### No filter
```{r}
p0 <- tar_read(trend_comp_0) |>
  filter(id_spat_res == "1km",
         time_period == "year") |>
  ggplot(aes(x = correlation, fill = category)) +
  geom_histogram() +
  xlim(-1, 1) +
  fill_scale +
  labs(x = "Correlation",
       y = "Number of species")

p0
```

### Filter 1
```{r}
p1 <- tar_read(trend_comp_1) |>
  filter(id_spat_res == "1km",
         time_period == "year") |>
  ggplot(aes(x = correlation, fill = category)) +
  geom_histogram() +
  xlim(-1, 1) +
  fill_scale +
  labs(x = "Correlation",
       y = "Number of species")

p1
```

### Filter 2
```{r}
p2 <- tar_read(trend_comp_2) |>
  filter(id_spat_res == "1km",
         time_period == "year") |>
  ggplot(aes(x = correlation, fill = category)) +
  geom_histogram() +
  xlim(-1, 1) +
  fill_scale +
  labs(x = "Correlation",
       y = "Number of species")

p2
```

### Filter 3
```{r}
p3 <- tar_read(trend_comp_3) |>
  filter(id_spat_res == "1km",
         time_period == "year",
         id_filter_per == "year") |>
  ggplot(aes(x = correlation, fill = category)) +
  geom_histogram() +
  xlim(-1, 1) +
  fill_scale +
  labs(x = "Correlation",
       y = "Number of species")

p3
```

### Filter 4
```{r}
p4 <- tar_read(trend_comp_4) |>
  filter(id_spat_res == "1km",
         time_period == "year",
         id_filter_per == "year",
         id_filter_per2 == "year") |>
  ggplot(aes(x = correlation, fill = category)) +
  geom_histogram() +
  xlim(-1, 1) +
  fill_scale +
  labs(x = "Correlation",
       y = "Number of species")

p4
```

##

```{r, include=FALSE}
library(cowplot)

middle_row <- plot_grid(p1 + theme(legend.position = "none"),
                        p2 + theme(legend.position = "none"),
                        labels = c("B", "C"),
                        label_size = 12)

bottom_row <- plot_grid(p3 + theme(legend.position = "none"),
                        p4 + theme(legend.position = "none"),
                        labels = c("D", "E"),
                        label_size = 12)

plot_grid(p0,
          middle_row,
          bottom_row,
          nrow = 3,
          labels = c("A", "", ""),
          label_size = 12)
```

## Trend comparison with data aggregated per cycle {.tabset}

```{r}
species_list_cor <- c("Motacilla flava", "Sylvia communis", "Motacilla alba",
                      "Cyanistes caeruleus", "Passer domesticus",
                      "Prunella modularis", "Parus montanus", "Chloris chloris",
                      "Anthus trivialis")
```

We include the trends of nine species:
 - Three have a strong positive correlation: **Parus montanus**, **Chloris chloris** and **Anthus trivialis**
 - Three have a almost zero correlation: **Cyanistes caeruleus**, **Passer domesticus** and **Prunella modularis**
 - Three have a strong negative correlation: **Motacilla flava**, **Sylvia communis** and **Motacilla alba**

### No filter
```{r}
trend_comp_0_cyclus <- tar_read(trend_comp_0) |>
  filter(id_spat_res == "1km",
         time_period == "cyclus")

p0 <- trend_comp_0_cyclus |>
  ggplot(aes(x = correlation, fill = category)) +
  geom_histogram() +
  xlim(-1, 1) +
  fill_scale +
  labs(x = "Correlation",
       y = "Number of species")

p0
```

```{r}
shared_filter0_cyclus <- SharedData$new(
  tar_read(data) |>
    filter(species %in% species_list_cor,
           id_spat_res == "1km") |>
    group_by(species, id_dataset, cyclus) |>
    summarise(n = sum(n))
)


bscols(
  widths = c(3, 9),
  filter_select("species", "Species",
                shared_filter0_cyclus,
                ~species,
                multiple = FALSE),
  plot_ly(shared_filter0_cyclus,
          x = ~cyclus,
          y = ~n,
          color = ~id_dataset) |> add_lines()
)
```

### Filter 1
```{r}
trend_comp_1_cyclus <- tar_read(trend_comp_1) |>
  filter(id_spat_res == "1km",
         time_period == "cyclus")

p1 <- trend_comp_1_cyclus |>
  ggplot(aes(x = correlation, fill = category)) +
  geom_histogram() +
  xlim(-1, 1) +
  fill_scale +
  labs(x = "Correlation",
       y = "Number of species")

p1
```

```{r}
shared_filter1_cyclus <- SharedData$new(
  tar_read(filter1) |>
    filter(species %in% species_list_cor,
           id_spat_res == "1km") |>
    group_by(species, id_dataset, cyclus) |>
    summarise(n = sum(n))
)


bscols(
  widths = c(3, 9),
  filter_select("species", "Species",
                shared_filter1_cyclus,
                ~species,
                multiple = FALSE),
  plot_ly(shared_filter1_cyclus,
          x = ~cyclus,
          y = ~n,
          color = ~id_dataset) |>
    add_lines()
)
```

### Filter 2
```{r}
trend_comp_2_cyclus <- tar_read(trend_comp_2) |>
  filter(id_spat_res == "1km",
         time_period == "cyclus")

p2 <- trend_comp_2_cyclus |>
  ggplot(aes(x = correlation, fill = category)) +
  geom_histogram() +
  xlim(-1, 1) +
  fill_scale +
  labs(x = "Correlation",
       y = "Number of species")

p2
```

```{r}
shared_filter2_cyclus <- SharedData$new(
  tar_read(filter2) |>
    filter(species %in% species_list_cor,
           id_spat_res == "1km",
           id_filter_per == "cyclus") |>
    group_by(species, id_dataset, cyclus) |>
    summarise(n = sum(n))
)


bscols(
  widths = c(3, 9),
  filter_select("species", "Species",
                shared_filter2_cyclus,
                ~species,
                multiple = FALSE),
  plot_ly(shared_filter2_cyclus,
          x = ~cyclus,
          y = ~n,
          color = ~id_dataset) |> add_lines()
)
```

### Filter 3
```{r}
trend_comp_3_cyclus <- tar_read(trend_comp_3) |>
  filter(id_spat_res == "1km",
         time_period == "cyclus",
         id_filter_per == "cyclus")

p3 <- trend_comp_3_cyclus |>
  ggplot(aes(x = correlation, fill = category)) +
  geom_histogram() +
  xlim(-1, 1) +
  fill_scale +
  labs(x = "Correlation",
       y = "Number of species")

p3
```

```{r}
shared_filter3_cyclus <- SharedData$new(tar_read(filter3) |>
                                          filter(species %in% species_list_cor,
                                                 id_spat_res == "1km",
                                                 id_filter_per == "cyclus"))


bscols(
  widths = c(3, 9),
  filter_select("species", "Species",
                shared_filter3_cyclus,
                ~species,
                multiple = FALSE),
  plot_ly(shared_filter3_cyclus,
          x = ~cyclus,
          y = ~n,
          color = ~id_dataset) |> add_lines()
)
```

### Filter 4
```{r}
trend_comp_4_cyclus <- tar_read(trend_comp_4) |>
  filter(id_spat_res == "1km",
         time_period == "cyclus",
         id_filter_per == "cyclus",
         id_filter_per2 == "cyclus")

p4 <- trend_comp_4_cyclus  |>
  ggplot(aes(x = correlation, fill = category)) +
  geom_histogram() +
  xlim(-1, 1) +
  fill_scale +
  labs(x = "Correlation",
       y = "Number of species")

p4
```

```{r}
shared_filter4_cyclus <- SharedData$new(tar_read(filter4) |>
                                          filter(species %in% species_list_cor,
                                                 id_spat_res == "1km",
                                                 id_filter_per == "cyclus",
                                                 id_filter_per2 == "cyclus"))


bscols(
  widths = c(3, 9),
  filter_select("species", "Species",
                shared_filter4_cyclus,
                ~species,
                multiple = FALSE),
  plot_ly(shared_filter4_cyclus,
          x = ~cyclus,
          y = ~n,
          color = ~id_dataset) |> add_lines()
)
```

##

```{r, include=FALSE}
library(cowplot)

middle_row <- plot_grid(p1 + theme(legend.position = "none"),
                        p2 + theme(legend.position = "none"),
                        labels = c("B", "C"),
                        label_size = 12)

bottom_row <- plot_grid(p3 + theme(legend.position = "none"),
                        p4 + theme(legend.position = "none"),
                        labels = c("D", "E"),
                        label_size = 12)

plot_grid(p0,
          middle_row,
          bottom_row,
          nrow = 3,
          labels = c("A", "", ""),
          label_size = 12)
```
