---
title: "Prepare ABV data"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(zen4R)
```

# Goal

Load and save structured data of the “Common Breeding Bird Survey Flanders” (ABV).
Load and save unstructured data.

# Structured data
## Sampling framework

We download the sampling framework from zenodo.

```{r}
# Data path and create directory if necessary
data_path <- file.path("data", "raw")
dir.create(data_path, showWarnings = FALSE, recursive = TRUE)

# Download data from zenodo if necessary
file_sampling_framework <- file.path(
  data_path,
  "steekproefkader.csv")

if (file.exists(file_sampling_framework)) {
  sampling_framework_abv <- read_csv(file_sampling_framework,
                                     show_col_types = FALSE)
} else {
  download_zenodo(
    doi = "10.5281/zenodo.10103472",
    path = data_path,
    files = list("steekproefkader.csv"))
  
  sampling_framework_abv <- read_csv(file_sampling_framework,
                                     show_col_types = FALSE)
}
```

We get a dataset with land use category per UTM grid cell (1x1 km).

```{r}
head(sampling_framework_abv)
```

## Occurrence data

Occurrence data is downloaded from GBIF.org.
Unzip and store folders under *./data/raw*.

**ABV - Common breeding birds in Flanders, Belgium**: 0000102-240626123714530.zip

GBIF.org (26 June 2024) GBIF Occurrence Download  https://doi.org/10.15468/dl.w8va93

**ABV - Common breeding birds in Flanders, Belgium (post 2016)**: 0000105-240626123714530.zip

GBIF.org (26 June 2024) GBIF Occurrence Download  https://doi.org/10.15468/dl.4htaqh


# Unstructured data

We retrieved species occurrence cubes using Microsoft Azure Databricks as described [here](https://techdocs.gbif.org/en/data-use/b-cubed/generate-cube-databricks).

We first selected all bird data in Belgium `birds_data.belgium` from 2007-2022 using this query:

```
CREATE DATABASE IF NOT EXISTS birds_data;
CREATE TABLE IF NOT EXISTS birds_data.belgium AS SELECT
  *
FROM
  gbif.occurrence
WHERE
  occurrenceStatus = 'PRESENT'
  AND NOT array_contains(issue.array_element, 'ZERO_COORDINATE')
  AND NOT array_contains(issue.array_element, 'COORDINATE_OUT_OF_RANGE')
  AND NOT array_contains(issue.array_element, 'COORDINATE_INVALID')
  AND NOT array_contains(issue.array_element, 'COUNTRY_COORDINATE_MISMATCH')
  AND countrycode = 'BE'
  AND year BETWEEN 2007 AND 2022
  AND speciesKey IS NOT NULL 
  AND decimallatitude IS NOT NULL
  AND decimallongitude IS NOT NULL
  AND class = 'Aves';
```

We excluded ABV data into a new table `birds_data.unstructured` using this SQL code:

```
CREATE TABLE IF NOT EXISTS birds_data.unstructured AS SELECT
  *
FROM
  birds_data.belgium
WHERE
  collectionCode != 'ABV';
```

## Occurrence cubes


