---
title: "Investigate dataset bias"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message=FALSE}
# Load packages
library(tidyverse) # Data wrangling and visualisation
library(dubicube)  # Cross-validation
library(sf)        # Spatial objects

# Source functions
source(here::here("source", "R", "download_occ_cube.R"))
source(here::here("source", "R", "get_dataset_names.R"))
```

# Goal

Investigate bias in indicators caused by the over/under representation of certain datasets in the occurrence cube.

# Load data

We download the occurrence cube.
This cube is four dimensional, where the fourth dimension is the dataset.

```{r, message=FALSE}
# nolint start: line_length_linter.
query <- "SELECT
  \"year\",
  GBIF_MGRSCode(1000, decimalLatitude, decimalLongitude,
  COALESCE(coordinateUncertaintyInMeters, 1000)) AS mgrsCode,
  speciesKey,
  species,
  family,
  datasetName,
  datasetKey,
  COUNT(*) AS n,
  MIN(COALESCE(coordinateUncertaintyInMeters, 1000)) AS minCoordinateUncertaintyInMeters,
  IF(ISNULL(family), NULL, SUM(COUNT(*)) OVER (PARTITION BY family)) AS familyCount
  FROM
  occurrence
  WHERE
  occurrenceStatus = 'PRESENT'
  AND NOT ARRAY_CONTAINS(issue, 'ZERO_COORDINATE')
  AND NOT ARRAY_CONTAINS(issue, 'COORDINATE_OUT_OF_RANGE')
  AND NOT ARRAY_CONTAINS(issue, 'COORDINATE_INVALID')
  AND NOT ARRAY_CONTAINS(issue, 'COUNTRY_COORDINATE_MISMATCH')
  AND level1gid = 'BEL.2_1'
  AND \"year\" >= 2007
  AND \"year\" <= 2022
  AND speciesKey IS NOT NULL
  AND decimalLatitude IS NOT NULL
  AND decimalLongitude IS NOT NULL
  AND class = 'Aves'
  AND collectionCode != 'ABV'
  GROUP BY
  \"year\",
  mgrsCode,
  speciesKey,
  species,
  family,
  datasetName,
  datasetKey
  ORDER BY
  \"year\" ASC,
  mgrsCode ASC,
  speciesKey ASC,
  datasetName ASC"
# nolint end

download_occ_cube(
  sql_query = query,
  file = "birdcubeflanders_dataset.csv",
  overwrite = FALSE
)
```

> GBIF.org (04 March 2025) GBIF Occurrence Download https://doi.org/10.15468/dl.kmzpht

We read in the data cube and add dataset names.

```{r}
birdcubeflanders_dataset_raw <- read_csv(
  here::here("data", "interim", "birdcubeflanders_dataset.csv"),
  show_col_types = FALSE)

# Add dataset names
birdcubeflanders_dataset <- get_dataset_names(birdcubeflanders_dataset_raw) %>%
  dplyr::select("mgrscode", "year", "specieskey", "species", "family",
                "datasetkey", "datasetname", "n",
                "mincoordinateuncertaintyinmeters", "familycount") %>%
  arrange(year, mgrscode, species, datasetname)

glimpse(birdcubeflanders_dataset)
```

There are `r nrow(birdcubeflanders_dataset)` rows in the dataset.
They should be the same as the unique combinations of grid cell code, species, year and dataset.

```{r}
n_distinct <- birdcubeflanders_dataset %>%
  distinct(mgrscode, specieskey, year, datasetname) %>%
  nrow()

nrow(birdcubeflanders_dataset) == n_distinct
```

Number of observations (sum) per dataset in the cube.

```{r}
birdcubeflanders_dataset %>%
  summarise(n_obs = sum(n),
            .by = "datasetname") %>%
  arrange(desc(n_obs)) %>%
  knitr::kable()
```

```{r}
birdcubeflanders_dataset %>%
  summarise(n_obs = sum(n),
            .by = "datasetname") %>%
  mutate(datasetname = reorder(datasetname, n_obs)) %>%
  ggplot(aes(x = datasetname, y = n_obs)) +
    geom_bar(stat = "identity",
             fill = "cornflowerblue") +
    geom_text(aes(label = n_obs), vjust = 0.3, hjust = -0.3, size = 3) +
    scale_x_discrete(label = function(x) stringr::str_trunc(x, 40)) +
    scale_y_continuous(limits = c(0, 10^7 + 1000000)) +
    labs(x = "", y = "Number of observations (sum)") +
    theme_minimal() +
    coord_flip()
```

# Comparing species prevalence
## Load and process data

We load the ABV data (structured monitoring data).
We categorise the species according to rarity:

| number of rows  | rarity           |
| :-------------: | :--------------- |
| [1, 10)         | very rare        |
| [10, 100)       | rare             |
| [100, 1000)     | common           |
| [1000, 10.000)  | very common      |
| [10.000, +Inf)  | extremely common |

```{r, message=FALSE}
abv_data_total_sf <- read_sf(
  here::here("data", "interim", "abv_data_total.gpkg"))

# Cut rarity
abv_data <- abv_data_total_sf %>%
  st_drop_geometry() %>%
  # Soepeend, Soepgans
  filter(!is.na(species)) %>%
  mutate(mgrscode = paste0("31U", TAG)) %>%
  dplyr::select("mgrscode", "year", "specieskey" = "speciesKey", "species") %>%
  mutate(n_obs = n(),
         .by = "species") %>%
  mutate(
    rarity = cut(
      n_obs,
      breaks = c(0, 10, 100, 1000, 10000, +Inf),
      labels = c("Very rare", "Rare", "Common",
                 "Very common", "Extremely common"),
      right = FALSE
    ),
    species = case_when(
      species == "Parus montanus" ~ "Poecile montanus",
      species == "Dendrocopus major" ~ "Dendrocopos major",
      species == "Saxicola torquatus" ~ "Saxicola rubicola",
      TRUE ~ species
      )
  ) %>%
  arrange(year, mgrscode, species)

glimpse(abv_data)
```

We filter the data cube based on species in ABV and add rarity categories.

```{r}
# Get ABV categories
abv_species <- unique(abv_data$species)

# Filter cube based on ABV species and add rarity categories
birdcube_dataset_filtered <- birdcubeflanders_dataset %>%
  dplyr::filter(species %in% abv_species) %>%
  left_join(distinct(abv_data[, c("species", "rarity")]),
            by = join_by("species"))

# Also aggregate over datasets
birdcube_filtered <- birdcube_dataset_filtered %>%
  group_by(mgrscode, year, specieskey, species, family, familycount, rarity) %>%
  summarise(
    n = sum(n),
    mincoordinateuncertaintyinmeters = min(mincoordinateuncertaintyinmeters),
    .groups = "drop"
  )
```

## Indicator calculation

We calculate species prevalence.
For each dataset we calculate the proportion of occupied grid cells by each species.

```{r}
species_prevalence <- function(df) {
  require("dplyr")
  require("rlang")

  total_grid_cells <- length(unique(df$mgrscode))
  
  df_out <- df %>%
    group_by(.data$species, .data$rarity) %>%
    summarise(prevalence = n_distinct(.data$mgrscode) / total_grid_cells,
              .groups = "drop")
  
  return(df_out)
}
```

```{r}
birdcube_prevalence <- species_prevalence(birdcube_filtered) %>%
  mutate(data = "birdcube")
abv_prevalence <- species_prevalence(abv_data) %>%
  mutate(data = "abv")

prevalence_df <- bind_rows(birdcube_prevalence, abv_prevalence) %>%
  pivot_wider(names_from = data, values_from = prevalence)
```

```{r}
prevalence_df %>%
  ggplot(aes(x = abv, y = birdcube)) +
    geom_smooth(method = "lm", formula = "y ~ log(x)", colour = "firebrick") +
    geom_point(aes(colour = rarity), size = 2) +
    labs(x = "Proportion of occupied grid cells\nin ABV dataset",
         y = "Proportion of occupied grid cells\nin cube dataset",
         colour = "Rarity") +
    theme_minimal()
```




- calculate indicator on birdcube_dataset_filtered with LOO CV

# Species specific indicators

- LOO CV on species specific indicators
