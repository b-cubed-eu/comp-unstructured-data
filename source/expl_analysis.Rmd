---
title: "Exploratory analysis"
author: "Emma Cartuyvels, Ward Langeraert"
date: "2024-07-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(sf)
library(mapview)
library(vcd)        # For Cohen’s Kappa to measure Inter-Rater Reliability
library(vegan)      # For Bray-Curtis dissimilarity and other ecological metrics
library(ecodist)    # For Mantel tests
library(ade4)       # For beta diversity
library(spatstat)   # For spatial pattern analysis
library(pscl)       # For occupancy modeling
library(geosphere)  # For spatial overlap
library(dplyr)
library(ggplot2)
library(tidyr)
library(INBOtheme)

conflicted::conflicts_prefer(dplyr::filter)
```

```{r data}
birdcubeflanders_year_sf <- read_sf(here::here("data", "interim",
                                            "birdcubeflanders_year.gpkg"))

abv_data_total_sf <- read_sf(here::here("data", "interim",
                                            "abv_data_total.gpkg"))
```

We noticed some problems with species names: *Poecile montanus* and *Parus montanus*, *Dendrocopus major* and *Dendrocopos major* both refer to the same species. Since both species names are accepted names in GBIF we need to manually correct this (an issue was made for this with GBIF). *Saxicola torquatus* is most likely a wrong name and needs to be replaced with *Saxicola rubicola* (an issue was also opened for this with the data publisher of the ABV data).

We summarise the ABV data per year and per km² so that it is comparable with the cube data. 

```{r transform abv}
abv_data_total <- abv_data_total_sf |>
  st_drop_geometry() |>
  mutate(cyclus = case_when(
    year >= 2007 & year <= 2009 ~ 1,
    year >= 2010 & year <= 2012 ~ 2,
    year >= 2013 & year <= 2015 ~ 3,
    year >= 2016 & year <= 2018 ~ 4,
    year >= 2019 & year <= 2021 ~ 5,
    year >= 2022 & year <= 2024 ~ 6
  )) |>
  mutate(species = case_when(
    species == "Parus montanus" ~ "Poecile montanus",
    species == "Dendrocopus major" ~ "Dendrocopos major",
    species == "Saxicola torquatus" ~ "Saxicola rubicola",
    TRUE ~ species
  )) |>
  group_by(species) |>
  mutate(n_obs = n()) |>
  ungroup() |>
  mutate(category = cut(n_obs,
                        breaks = c(0, 10, 100, 1000, 10000, +Inf),
                        labels = c("Very rare", "Rare", "Common",
                                   "Very common", "Extremely common"),
                        right = FALSE))

birdcubeflanders_year <- birdcubeflanders_year_sf |>
  st_drop_geometry() |>
  mutate(cyclus = case_when(
    year >= 2007 & year <= 2009 ~ 1,
    year >= 2010 & year <= 2012 ~ 2,
    year >= 2013 & year <= 2015 ~ 3,
    year >= 2016 & year <= 2018 ~ 4,
    year >= 2019 & year <= 2021 ~ 5,
    year >= 2022 & year <= 2024 ~ 6
  ))

abv_data_total_tf <- abv_data_total |>
  group_by(species, year, TAG, category) |>
  summarise(n = sum(individualCount)) |>
  ungroup()
```


# Introduction

## The ABV dataset

The ABV dataset, which stands for Algemene Broedvogelmonitoring Vlaanderen (Common Breeding Bird Survey Flanders), is a structured monitoring dataset that tracks a group of approximately 100 common breeding bird species in Flanders, Belgium. Monitoring began in 2007 and the protocol involves selecting a random sample of 1200 UTM 1x1 km grid cells, stratified by land use. These cells are divided into groups of 300, and 300 grid cells are visited each year on a three-year rotation. Each grid cell contains six monitoring locations where bird counts are conducted. The data collection is standardized, with each grid cell being visited three times a year at fixed intervals (at least two weeks apart).

```{r}
summary(abv_data_total[, c("individualCount",
                          "eventDate",
                          "year",
                          "month")])
```

```{r}
abv_data_total_tf |>
  group_by(species) |>
  summarise(n_obs = n()) |>
  ggplot(aes(x = n_obs)) +
  geom_histogram() +
  labs(x = "Number of observations (grouped per km² and year)",
       y = "Number of species")
```

There are 181 species present in the dataset. There are 34 species that were observed less than 10 times, 45 species that were observed more than 1000 times and 12 species that were observed more than 10 000 times. This dataset also contains absence data, which is not included in the cube.

```{r}
abv_data_total |>
  distinct(category, species) |>
  group_by(category) |>
  summarise(n())
```

## The cube data

The cube contains 2 011 808 observations. There are 666 species present in the data. 355 of these were observed less than a 100 times, 197 were observed more than 1000 times. More information can be found [here]( https://docs.b-cubed.eu/occurrence-cube/specification/#dimensions).

The cube is made up of several datasets:

  - Waarnemingen.be - Bird occurrences in Flanders and the Brussels Capital Region, Belgium
  - Watervogels - Wintering waterbirds in Flanders, Belgium
  - HG_OOSTENDE - Herring gulls (Larus argentatus, Laridae) breeding at the southern North Sea coast (Belgium)
  - EOD – eBird Observation Dataset
  - Waarnemingen.be - Non-native animal occurrences in Flanders and the Brussels Capital Region, Belgium
  - LBBG_ZEEBRUGGE - Lesser black-backed gulls (Larus fuscus, Laridae) breeding at the southern North Sea coast (Belgium and the Netherlands)
  - Broedvogels - Atlas of the breeding birds in Flanders 2000-2002
  - European Seabirds At Sea (ESAS)
  - And 80+ smaller datasets
  
With the first dataset (waarnemingen.be) containing most of the observations (67%). For further analyses it is important to know that waarnemingen.be data was last published in 2019 and currently runs only to 31 december 2018.

```{r}
birdcubeflanders_year |>
  st_drop_geometry() |>
  group_by(species) |>
  summarise(n_obs = n()) |>
  ggplot(aes(x = n_obs)) +
  geom_histogram() +
  labs(x = "Number of observations (grouped per km² and year)",
       y = "Number of species")
```

```{r}
birdcubeflanders_year |>
  st_drop_geometry() |>
  group_by(species) |>
  summarise(n_obs = n()) |>
  mutate(category = cut(n_obs,
                        breaks = c(-Inf, 0, 1, 10, 100, 1000, 10000, Inf),
                        right = FALSE)) |>
  group_by(category) |>
  summarise(n())
```

### Filter cube for specific ABV squares and years

```{r}
utm_year <- abv_data_total |>
  st_drop_geometry() |>
  distinct(TAG, year)
```

```{r}
filt_birdcube <- utm_year |>
  left_join(birdcubeflanders_year, by = c("TAG", "year"))
```

```{r}
filt_birdcube |>
  st_drop_geometry() |>
  group_by(species) |>
  summarise(n_obs = n()) |>
  mutate(category = cut(n_obs,
                        breaks = c(-Inf, 0, 1, 10, 100, 1000, 10000, Inf),
                        right = FALSE)) |>
  group_by(category) |>
  summarise(n())
```


# Comparing the data

```{r}
studied_spec <- unique(abv_data_total$species) |>
  na.omit()
```

Let's check if these species are observed in the same utm squares for the full period. Let's make this a function depending on period and species that gives us the percentage of squares.

```{r}
range_comp <- function(sel_species, period = 2007:2022,
                       dataset1 = abv_data_total,
                       dataset2 = birdcubeflanders_year) {

  # We filter both datasets for the species and period of interest
  # and group them by TAG (identifier of utm square)
  set_abv <- dataset1 |>
    st_drop_geometry() |>
    filter(.data$species %in% sel_species,
           .data$year %in% period,
           .data$individualCount > 0) |>
    group_by(.data$TAG) |>
    summarise(n = sum(.data$individualCount))

  set_cube <- dataset2 |>
    st_drop_geometry() |>
    filter(.data$species %in% sel_species,
           .data$year %in% period) |>
    group_by(.data$TAG) |>
    summarise(n = sum(.data$n))

  total_abv <- length(set_abv$TAG)
  perc_abv <- (total_abv / 936) * 100

  overlap_all_abv_cube <- length(
    which(set_cube$TAG %in% unique(abv_data_total$TAG))
    )
  perc_overlap_all <- (overlap_all_abv_cube / 936) * 100

  total_overlap <- length(which(set_cube$TAG %in% set_abv$TAG))
  perc <- (total_overlap / total_abv) * 100

  list(total_abv, perc_abv, overlap_all_abv_cube, perc_overlap_all,
       total_overlap, perc)
}

```

```{r}
comp_range_data <- as.data.frame(studied_spec)
comp_range_data$abv_squares <- NA
comp_range_data$perc_abv_total_abv <- NA
comp_range_data$overlap_birdcube_total_abv <- NA
comp_range_data$perc_birdcube_total_abv <- NA
comp_range_data$overlap_birdcube_spec_abv <- NA
comp_range_data$percentage_birdcube_spec_abv <- NA

for (i in studied_spec){
  comp_range_data[comp_range_data$studied_spec == i, 2] <- range_comp(i)[1]
  comp_range_data[comp_range_data$studied_spec == i, 3] <- range_comp(i)[2]
  comp_range_data[comp_range_data$studied_spec == i, 4] <- range_comp(i)[3]
  comp_range_data[comp_range_data$studied_spec == i, 5] <- range_comp(i)[4]
  comp_range_data[comp_range_data$studied_spec == i, 6] <- range_comp(i)[5]
  comp_range_data[comp_range_data$studied_spec == i, 7] <- range_comp(i)[6]
}

```

```{r}
comp_range_data |>
  inner_join(abv_data_total |> distinct(species, category),
            by = join_by(studied_spec == species)) |>
  DT::datatable() |>
  DT::formatRound(columns = c("perc_abv_total_abv",
                              "perc_birdcube_total_abv",
                              "percentage_birdcube_spec_abv"), digits = 2)
```

This table shows the percentage of squares were the species was observed in both the cubes and the ABV monitoring compared to all squares where the species was observed during the ABV monitoring. Overall we see an overlap of `r sum(comp_range_data$percentage_birdcube_spec_abv)/sum(comp_range_data$abv_squares)`.

# 1. Trend Analysis
## Correlation of time series of species occurrences

```{r Correlation of time series per year of species occurrences}
time_series_1 <- abv_data_total |>
  st_drop_geometry() %>%
  group_by(species, year) %>%
  summarize(occurrence = sum(occurrenceStatus == "PRESENT"))

time_series_2 <- birdcubeflanders_year |>
  st_drop_geometry()  |>
  group_by(species, year)  |>
  summarize(occurrence = n())

# Pearson Correlation for each species
# inner_join makes sure that only species-year combinations present
# in both datasets are included
time_series_cor <- time_series_1 %>%
  inner_join(time_series_2,
             by = c("species", "year"),
             suffix = c("_1", "_2")) %>%
  group_by(species) %>%
  summarize(correlation = cor(occurrence_1, occurrence_2, method = "pearson"))
```

```{r}
DT::datatable(time_series_cor) |>
  DT::formatRound(columns = "correlation", digits = 2)
```

```{r Correlation of time series per cyclus of species occurrences}
time_series_1 <- abv_data_total |>
  st_drop_geometry() %>%
  group_by(species, cyclus) %>%
  summarize(occurrence = sum(occurrenceStatus == "PRESENT"))

time_series_2 <- birdcubeflanders_year |>
  st_drop_geometry()  |>
  group_by(species, cyclus)  |>
  summarize(occurrence = n())

# Pearson Correlation for each species
# inner_join makes sure that only species-year combinations present
# in both datasets are included
time_series_cor <- time_series_1 %>%
  inner_join(time_series_2,
             by = c("species", "cyclus"),
             suffix = c("_1", "_2")) %>%
  group_by(species) %>%
  summarize(correlation = cor(occurrence_1, occurrence_2, method = "pearson"))
```

```{r}
DT::datatable(time_series_cor) |>
  DT::formatRound(columns = "correlation", digits = 2)
```

```{r Correlation of time series per cyclus of species numbers}
time_series_1 <- abv_data_total |>
  st_drop_geometry() %>%
  group_by(species, cyclus) %>%
  summarize(abundance = sum(individualCount))

time_series_2 <- birdcubeflanders_year |>
  st_drop_geometry()  |>
  group_by(species, cyclus)  |>
  summarize(abundance = sum((n)))

# Pearson Correlation for each species
# inner_join makes sure that only species-year combinations present
# in both datasets are included
time_series_cor <- time_series_1 %>%
  inner_join(time_series_2,
             by = c("species", "cyclus"),
             suffix = c("_1", "_2")) %>%
  group_by(species) %>%
  summarize(correlation = cor(abundance_1, abundance_2, method = "pearson"))
```

```{r}
DT::datatable(time_series_cor) |>
  DT::formatRound(columns = "correlation", digits = 2)
```
## Trend similarity

```{r}
abv_data_total |>
  group_by(cyclus, species) |>
  summarise(total = sum(individualCount)) |>
  pivot_wider(names_from = cyclus,
              names_prefix = "abv_",
              values_from = total,
              values_fill = 0)

birdcubeflanders_year |>
  filter(species %in% studied_spec) |>
  group_by(cyclus, species) |>
  summarise(total = sum(n)) |>
  pivot_wider(names_from = cyclus,
              names_prefix = "cube_",
              values_from = total,
              values_fill = 0)
```



# 2. Occupancy Rate Comparison

Compare the occupancy rate (percentage of km² where a species is present) between the two datasets for each species.

all abv squares 936
all birdcube squares 13596

Kappa is not a good measure for comparing two discrete continuous variables, better to use this later when comparing categories, i.e. increase, decrease, ...

```{r}
occupancy_1 <- abv_data_total %>%
  group_by(species, TAG) %>%
  summarize(occupancy_rate_1 = mean(occurrenceStatus == "PRESENT"))

occupancy_2 <- birdcubeflanders_year %>%
  group_by(species) %>%
  summarize(occupancy_rate_2 = mean(n()))

occupancy_comparison <- occupancy_1 %>%
  inner_join(occupancy_2, by = "species") %>%
  summarize(kappa = Kappa(occupancy_rate_1, occupancy_rate_2)$value)
```

# 3. Species Richness and Composition

```{r}
# Species richness per dataset
richness_1 <- abv_data_total |>
  group_by(TAG) |>
  summarize(richness = n_distinct(species))

richness_2 <- birdcubeflanders_year  |>
  group_by(TAG) |>
  summarize(richness = n_distinct(species))

# Bray-Curtis dissimilarity
species_composition_1 <- abv_data_total  |>
  drop_na(species) |> 
  count(species) |>
  pivot_wider(names_from = species,
              values_from = n,
              values_fill = 0)

species_composition_2 <- birdcubeflanders_year |>
  filter(species %in% studied_spec) |>
  count(species) |>
  pivot_wider(names_from = species,
              values_from = n,
              values_fill = 0)

bray_curtis <- vegdist(rbind(species_composition_1[-1],
                             species_composition_2[-1]), method = "bray")
```


```{r}
# 4. Spatial Patterns
# Spatial autocorrelation with Moran's I
moran_1 <- moran.test(dataset1$presence, nb2listw(poly2nb(dataset1)))
moran_2 <- moran.test(dataset2$presence, nb2listw(poly2nb(dataset2)))

# Spatial overlap
overlap <- geosphere::areaPolygon(intersect(st_union(dataset1),
                                            st_union(dataset2)))

# 5. Model-Based Comparisons (Occupancy Models)
# Fit occupancy models to both datasets
occupancy_model_1 <- zeroinfl(presence ~ species + offset(log(year)) | 1,
                              data = dataset1)
occupancy_model_2 <- zeroinfl(presence ~ species + offset(log(year)) | 1,
                              data = dataset2)

# Compare model coefficients
summary(occupancy_model_1)$coefficients
summary(occupancy_model_2)$coefficients

# 6. Detection/Non-Detection Agreement
detection_matrix_1 <- dataset1 %>%
  group_by(species, geometry) %>%
  summarize(detected = any(presence > 0))

detection_matrix_2 <- dataset2 %>%
  group_by(species, geometry) %>%
  summarize(detected = any(presence > 0))

concordance <- detection_matrix_1 %>%
  inner_join(detection_matrix_2,
             by = c("species", "geometry"),
             suffix = c("_1", "_2")) %>%
  summarize(agreement = mean(detected_1 == detected_2))

# 7. Temporal Synchrony (if applicable)
# Compare timing of species occurrences (phenology)
# This depends on more granular temporal data

# 8. Data Quality Indicators
# Compare sampling effort
sampling_effort_1 <- dataset1 %>%
  group_by(geometry, year) %>%
  summarize(surveys = n())

sampling_effort_2 <- dataset2 %>%
  group_by(geometry, year) %>%
  summarize(surveys = n())

# Compare detection probabilities if available (requires further modeling)
```
